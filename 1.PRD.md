# 产品需求文档 (PRD)

## 1. 引言

PersistentMemoryAgent (Persistent Memory Agent) 是一个AI代理，其核心设计理念是超越传统的"聊天历史记录"，构建一个动态、自组织、可供LLM主动探索的长期记忆系统。v3.0 的核心是实现一个名为**动态记忆森林 (Dynamic Memory Forest)** 的高级记忆架构。

此架构将 PersistentMemoryAgent 定位为一个**专用的、可通过标准API（如MCP）集成的记忆工具**，赋能任何第三方AI代理，使其具备深度、结构化的长期记忆能力。

## 2. 愿景

赋能AI，使其不仅能"记住"信息，更能"理解"和"组织"信息。PersistentMemoryAgent 将能够围绕特定主题，自动将零散的对话或文档，构建成结构化的**记忆树**。当需要回忆时，外部AI代理可以像人类一样，首先定位到相关的记忆主题（树），然后由粗到细地探索摘要层级，直至找到最精确的信息片段。

我们有两个预测：
1、未来3年，语音交互会达到50%以上。
2、技术路线上，RAG+MCP的方式能够改进ai助手的记忆模块，使其更智能。

## 3. 核心特性

### 3.1. 动态记忆森林 (Dynamic Memory Forest)

-   **描述**: PersistentMemoryAgent 的记忆不再是扁平的列表，而是一个由多棵独立的**记忆树 (Memory Trees)** 组成的森林。每一棵树都代表一个独立、连贯的记忆主题（例如，一个项目、一次深入的讨论、一份报告），在技术上称为一个**档案 (Archive)**。
-   **实现**: 每棵树都由**记忆节点 (Memory Nodes)** 构成。节点分为两种：
    -   **叶子节点 (Leaf Nodes)**: 存储原始的文本块。
    -   **摘要节点 (Summary Nodes)**: 存储由其子节点内容生成的摘要。
-   **价值**: 这种结构将无序的信息流，转化为结构化的知识体系，是实现深度推理的基础。

### 3.2. 智能归档：层级摘要聚合

-   **描述**: 当接收到一份长文档或一段长对话时，PersistentMemoryAgent 会自动执行一个"智能归档"流程。它首先将信息进行语义分块，作为记忆树的叶子节点。然后，通过**迭代式摘要合并**，不断地将最相似的节点（无论是叶子还是低层摘要）合并成一个更高层级的摘要节点。这个过程会一直持续，直到整个主题被构建成一棵或多棵层次分明的摘要树。
-   **价值**: 实现了记忆的自动、分层、有机组织，完全无需人工干预。

### 3.3. 结构化回忆与代理式探索 (Structured Recall & Agentic Exploration)

-   **描述**: 这是外部AI代理利用 PersistentMemoryAgent 记忆森林进行思考的核心交互模式，分为两个阶段：
    1.  **智能检索与归档 (Intelligent Retrieval & Consolidation)**: 当代理向 PersistentMemoryAgent 提问时，PersistentMemoryAgent 首先在整个记忆森林中进行全局搜索，找出所有相关的记忆片段。接着，它会智能地将来自同一文档（树）的多个相关片段，整合成一个**“最近公共祖先”摘要节点**。这为AI代理提供了一个既全面又高度概括的、无冗余信息的起点。
    2.  **代理驱动的探索 (Agent-Driven Exploration)**: H.E.R. 将这些高度相关的“代表性节点”返回给AI代理。如果代理判断某个摘要信息不足，它可以发起一次**工具调用(Tool Call)**，请求 H.E.R. **“向下钻取”**，以获取该摘要对应的更详细的子节点信息。这个探索过程由代理自主决策，可以递归进行。
-   **价值**: 赋予AI代理一种接近人类的、结构化的信息检索与推理能力。它不再是在信息的海洋中盲目搜索，而是像专家一样，先定位主题，再按需深入，极大提升了上下文的准确性和对话的相关性。

## 4. 用户故事 (User Stories)

-   **US-1 (记忆归档)**:
    -   **As a** Project Manager,
    -   **I want** to upload our 50-page project proposal document to my H.E.R. agent,
    -   **So that** the agent can automatically read, understand, and build a structured memory about this proposal without me having to manually summarize it.

-   **US-2 (信息回忆)**:
    -   **As a** Project Manager,
    -   **I want** to ask my H.E.R. agent, "What were the key risks identified in the Phoenix project proposal?",
    -   **So that** the agent can first use the H.E.R. memory tool to identify the 'Phoenix proposal' memory tree, then navigate down the summary layers to the 'risk assessment' section, and finally provide me with a precise and concise answer based on the detailed text chunks.

## 5. 工作流程 (Workflows)

### 阶段一：智能归档 (Memory Archiving)

当用户通过API提交一份文档时，`Memory Service` 会启动此流程来构建一棵新的记忆树。

1.  **创建档案**: 为新文档在系统中创建一个新的、独立的"档案"记录，代表一棵新的记忆树。
2.  **语义分块 (叶子节点)**: 将文档内容切分成多个语义连贯的文本块。每个文本块都成为一个"叶子节点"并存入数据库。
3.  **迭代合并 (构建树)**: 系统进入一个循环：
    a.  在当前所有的"根"节点（没有父节点的节点）中，寻找所有相邻节点对中语义最相似的一对。
    b.  为这对节点创建一个新的"摘要节点"作为它们的父节点。
    c.  不断重复此过程，直到只剩下一个（或少数几个）根节点，形成一棵完整的树。

### 阶段二：代理式回忆与推理 (Agentic Recall & Reasoning)

当外部AI代理通过API发起一个查询时，此流程被触发。

1.  **全局检索 (Global Retrieval)**: `Memory Service` 接收代理的查询，在指定 `model_id` 的所有记忆节点中进行全局向量搜索，找出初始的`Top-K`个最相关节点。
2.  **代表性节点合并 (Representative Node Consolidation)**: 系统分析检索结果。
    a.  **分组**: 将结果按其所属的**档案 (Archive)** 进行分组。
    b.  **合并**: 对于在同一个档案内命中了多个节点的情况，系统会计算这些节点的**最近公共祖先 (Lowest Common Ancestor, LCA)**。这个LCA节点将作为一个单一的、更高层次的摘要，代表所有这些分散的细节。
    c.  **返回**: 系统将这些经过处理的“代表性节点”（包括独立的命中节点和合并后的LCA节点）列表返回给AI代理。
3.  **代理驱动的探索 (Agent-Driven Exploration)**:
    a.  AI代理接收到代表性节点列表，并分析其摘要内容。
    b.  **如果信息足够**，代理直接生成答案。
    c.  **如果信息不足**（例如，一个LCA节点的摘要表明了相关性，但缺乏细节），代理会向PersistentMemoryAgent的API发起一次**工具调用** (e.g., `GET /tools/explore_memory_node?node_id=...`)，精确请求探索该摘要节点的下一层。
    d.  `Memory Service` 接收到工具调用，查找该节点的**直接子节点**，使用`Reranker`模型筛选出与原始查询最相关的子节点，并将其返回给代理。
    e.  代理将新获取的细节注入其上下文，重新生成或优化答案。这个向下探索的过程可以由代理根据需要重复进行。

## 6. 非功能性需求

-   **性能**: "全局检索"阶段必须非常快，以保证交互的低延迟。
-   **数据隔离**: 严格保证不同 `model_id` 之间的记忆森林是完全隔离的。
-   **兼容性**: API应保持与OpenAI Chat Completions格式的高度兼容。
-   **互操作性**: 核心回忆与探索功能应通过标准的**MCP (Machine Communication Protocol)** 协议作为工具暴露，确保能被主流AI代理框架轻松集成。